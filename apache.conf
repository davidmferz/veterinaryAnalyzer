# Configuración de Apache para Angular + API Backend
# Este archivo debe copiarse a /etc/apache2/sites-available/vhs-analyzer.conf

<VirtualHost *:80>
    ServerName YOUR_IP_OR_DOMAIN
    ServerAdmin admin@localhost

    # Logs
    ErrorLog ${APACHE_LOG_DIR}/vhs-frontend-error.log
    CustomLog ${APACHE_LOG_DIR}/vhs-frontend-access.log combined

    # Frontend Angular (SPA)
    DocumentRoot /var/www/vhs-analyzer
    
    <Directory /var/www/vhs-analyzer>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # Fallback para Angular routing (SPA)
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </Directory>

    # Headers de seguridad
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"

    # Cache para assets estáticos
    <FilesMatch "\.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$">
        Header set Cache-Control "max-age=31536000, public, immutable"
    </FilesMatch>

    # Proxy para el backend API FastAPI
    ProxyPreserveHost On
    ProxyTimeout 120
    
    # Health check endpoint
    ProxyPass /health http://localhost:8000/health
    ProxyPassReverse /health http://localhost:8000/health
    
    # API endpoints
    ProxyPass /v1 http://localhost:8000/v1
    ProxyPassReverse /v1 http://localhost:8000/v1
    
    # CORS headers para la API
    <Location /v1>
        Header always set Access-Control-Allow-Origin "*"
        Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Header always set Access-Control-Allow-Headers "Content-Type, Authorization"
        Header always set Access-Control-Max-Age "3600"
        
        # Responder a OPTIONS (preflight)
        <If "%{REQUEST_METHOD} == 'OPTIONS'">
            Header always set Content-Length "0"
            Header always set Content-Type "text/plain"
            Require all granted
        </If>
    </Location>

    # Tamaño máximo de carga (10MB para imágenes)
    LimitRequestBody 10485760

</VirtualHost>
